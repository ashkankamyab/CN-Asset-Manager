{% extends "base.html" %}
{% load humanize %}

{% block title %}Assets - Cloud Native Asset Manager{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
<li class="breadcrumb-item active">Assets</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="mb-0">Asset Inventory</h4>
  <div class="d-flex gap-2">
    <a href="{% url 'exports:csv' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-filetype-csv me-1"></i>Export CSV
    </a>
    <a href="{% url 'exports:excel' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
    </a>
    <a href="{% url 'assets:add' %}" class="btn btn-sm btn-primary">
      <i class="bi bi-plus-lg me-1"></i>Add Asset
    </a>
  </div>
</div>

<div class="row g-4">
  <!-- Filters -->
  <div class="col-lg-3">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h6>
      </div>
      <div class="card-body">
        <form method="get" action="{% url 'assets:list' %}">
          <div class="mb-3">
            <label class="form-label small fw-bold">Search</label>
            <input type="text" name="search" class="form-control form-control-sm"
              value="{{ filter_form.search.value|default_if_none:'' }}"
              placeholder="Name, ID, ARN...">
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold">Asset Type</label>
            <select name="asset_type" class="form-select form-select-sm">
              <option value="">All Types</option>
              {% for val, label in filter_form.fields.asset_type.choices %}
                {% if val %}
                <option value="{{ val }}" {% if filter_form.asset_type.value == val %}selected{% endif %}>{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold">AWS Service</label>
            <select name="aws_service_type" class="form-select form-select-sm">
              <option value="">All Services</option>
              {% for val, label in filter_form.fields.aws_service_type.choices %}
                {% if val %}
                <option value="{{ val }}" {% if filter_form.aws_service_type.value == val %}selected{% endif %}>{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold">Criticality</label>
            <select name="criticality" class="form-select form-select-sm">
              <option value="">All</option>
              {% for val, label in filter_form.fields.criticality.choices %}
                {% if val %}
                <option value="{{ val }}" {% if filter_form.criticality.value == val %}selected{% endif %}>{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold">Status</label>
            <select name="status" class="form-select form-select-sm">
              <option value="">All</option>
              {% for val, label in filter_form.fields.status.choices %}
                {% if val %}
                <option value="{{ val }}" {% if filter_form.status.value == val %}selected{% endif %}>{{ label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold">AWS Account</label>
            <select name="aws_account" class="form-select form-select-sm">
              <option value="">All Accounts</option>
              {% for account in aws_accounts %}
              <option value="{{ account.pk }}" {% if filter_form.aws_account.value|slugify == account.pk|slugify %}selected{% endif %}>
                {{ account.account_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold">Region</label>
            <select name="aws_region" class="form-select form-select-sm">
              <option value="">All Regions</option>
              {% for region in regions %}
              <option value="{{ region }}" {% if filter_form.aws_region.value == region %}selected{% endif %}>{{ region }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">Apply Filters</button>
          <a href="{% url 'assets:list' %}" class="btn btn-outline-secondary btn-sm w-100">Clear</a>
        </form>
      </div>
    </div>
  </div>

  <!-- Asset Table -->
  <div class="col-lg-9">
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <form method="post" action="{% url 'assets:bulk_update' %}" id="bulkForm">
          {% csrf_token %}
          <!-- Bulk actions bar -->
          <div class="p-3 bg-light border-bottom d-none" id="bulkActions">
            <div class="d-flex align-items-center gap-3">
              <span id="selectedCount" class="fw-bold">0 selected</span>
              <input type="hidden" name="asset_ids" id="assetIds">
              <select name="criticality" class="form-select form-select-sm" style="width:auto">
                <option value="">Criticality...</option>
                <option value="CRITICAL">Critical</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
              </select>
              <input type="text" name="owner" class="form-control form-control-sm" style="width:150px" placeholder="Owner...">
              <button type="submit" class="btn btn-sm btn-primary">Update Selected</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:30px"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                  <th><a href="?{{ request.GET.urlencode }}&sort={% if current_sort == 'asset_id' %}-{% endif %}asset_id" class="text-decoration-none text-muted">ID</a></th>
                  <th><a href="?{{ request.GET.urlencode }}&sort={% if current_sort == 'name' %}-{% endif %}name" class="text-decoration-none text-muted">Name</a></th>
                  <th>Service</th>
                  <th>Account</th>
                  <th>Region</th>
                  <th><a href="?{{ request.GET.urlencode }}&sort={% if current_sort == 'criticality' %}-{% endif %}criticality" class="text-decoration-none text-muted">Criticality</a></th>
                  <th><a href="?{{ request.GET.urlencode }}&sort={% if current_sort == 'status' %}-{% endif %}status" class="text-decoration-none text-muted">Status</a></th>
                  <th>Last Seen</th>
                </tr>
              </thead>
              <tbody>
                {% for asset in assets %}
                <tr>
                  <td><input type="checkbox" class="form-check-input asset-check" value="{{ asset.pk }}"></td>
                  <td><a href="{% url 'assets:detail' asset.pk %}"><code>{{ asset.asset_id }}</code></a></td>
                  <td>
                    <a href="{% url 'assets:detail' asset.pk %}" class="text-decoration-none">{{ asset.name|truncatechars:50 }}</a>
                    {% if asset.is_manually_added %}<span class="badge bg-info ms-1">Manual</span>{% endif %}
                  </td>
                  <td>{% if asset.aws_service_type %}<span class="badge bg-dark">{{ asset.aws_service_type }}</span>{% else %}{{ asset.get_asset_type_display }}{% endif %}</td>
                  <td>{% if asset.aws_account %}{{ asset.aws_account.account_name|truncatechars:20 }}{% endif %}</td>
                  <td><small>{{ asset.aws_region }}</small></td>
                  <td>
                    <span class="badge badge-{{ asset.criticality|lower }}">{{ asset.criticality }}</span>
                  </td>
                  <td>
                    <span class="badge badge-{{ asset.status|lower }}">{{ asset.get_status_display }}</span>
                  </td>
                  <td><small>{% if asset.last_seen_at %}{{ asset.last_seen_at|timesince }} ago{% endif %}</small></td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="9" class="text-center text-muted py-4">
                    No assets found. <a href="{% url 'assets:add' %}">Add manually</a> or <a href="{% url 'discovery:jobs' %}">run discovery</a>.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </form>
      </div>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
          <li class="page-item"><a class="page-link" href="?{{ request.GET.urlencode }}&page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">Next</a></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('selectAll');
  const checks = document.querySelectorAll('.asset-check');
  const bulkActions = document.getElementById('bulkActions');
  const selectedCount = document.getElementById('selectedCount');
  const assetIds = document.getElementById('assetIds');

  function updateBulk() {
    const selected = document.querySelectorAll('.asset-check:checked');
    if (selected.length > 0) {
      bulkActions.classList.remove('d-none');
      selectedCount.textContent = selected.length + ' selected';
      assetIds.value = Array.from(selected).map(c => c.value).join(',');
    } else {
      bulkActions.classList.add('d-none');
    }
  }

  selectAll.addEventListener('change', function() {
    checks.forEach(c => c.checked = this.checked);
    updateBulk();
  });
  checks.forEach(c => c.addEventListener('change', updateBulk));
});
</script>
{% endblock %}
